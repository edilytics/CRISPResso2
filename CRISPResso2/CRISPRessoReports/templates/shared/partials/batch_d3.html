<style>
    .qw {
             background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' stroke='%23D9D9D9FF' stroke-width='4' stroke-dasharray='6%2c14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
           }
  </style>
  <script type="text/javascript">
   const buildNucleotideQuilt = (data, slug) => {
     const color = {
       "A": "#7FC97F",
       "T": "#BEAED4",
       "C": "#FDC086",
       "G": "#FFFF99",
       "N": "#C8C8C8",
       "-": "#000000", 
       "Insertions": "#C18172",
       "sgRNA": "#D9D9D9",
     }
     const seqLength = data["reference"].length,
           tableCellHeight = 10,
           tableCellWidth = 10,
           batchCellHeight = 30,
           batchPadding = tableCellHeight / 5,
           numGuides = data["sgRNAs"].length,
           numGuideRows = Math.max(...data["sgRNAs"].map(d => d["row"])) + 1,
           numBatches = data["batches"].length,
           minPlotPct = 0.01,
           shadeReference = true
     const guidePadding = tableCellHeight / 2
     const guideHeight = numGuides > 0 ? (guidePadding * 2) + (numGuideRows * tableCellHeight) : 0,
           batchHeight = (numBatches * batchCellHeight) + (tableCellHeight * 2)
     const quiltHeight = batchHeight + guideHeight + (guidePadding * 2)
  
     const quiltSvg = d3.select(`#${slug}`)
                        .append("svg")
                        .attr("viewBox", `0 -10 ${(seqLength * tableCellWidth) + 50} ${quiltHeight}`)
                        .style("user-select", "none")
                        .style("height", `${quiltHeight * 2}px`)
  
     const y = d3.scaleLinear()
                 .domain([0, 1])
                 .range([batchCellHeight - batchPadding, 0])
  
     const stackGen = d3.stack()
                        .keys(["A", "C", "G", "T", "-", "Insertions"])
                        .order(d3.stackOrderNone)
                        .offset(d3.stackOffsetNone)
  
     const tooltip = d3.select("body")
                       .append("div")
                       .style("position", "absolute")
                       .style("z-index", "10")
                       .style("visibility", "hidden")
                       .style("background-color", "#FFFFFF")
                       .style("border", "solid")
                       .style("border-width", "1px")
                       .style("border-radius", "5px")
                       .style("padding", "10px")
                       .style("opacity", "0.9")
     const innerTooltip = tooltip.append("div")
                                 .attr("class", "text-center")
                                 .style("display", "grid")
                                 .style("grid-template-columns", "1fr 1fr")
                                 .style("column-gap", "10px")
  
     const defaultTooltipData = Object.keys(color)
                                      .filter(d => d !== "sgRNA")
                                      .reduce((o, key) => ({ ...o, [key]: "0%"}), {})
     const tooltipMouseover = function(d) {
       let key = d3.select(this.parentNode).datum().key,
           tooltipData = {...defaultTooltipData, ...d.data}
       let tooltipHtml = Object.entries(tooltipData)
                               .map(([key, value]) => {
                                 if(typeof value === 'number') {
                                   value = (value * 100).toPrecision(3) + '%'
                                 }
                                 var keyStyle = ''
                                 if(color.hasOwnProperty(key)) {
                                   keyStyle = `background-color: ${color[key]}; `
                                   if(key == '-') {
                                     keyStyle += 'color: white'
                                   }
                                 }
                                 return `<div style="${keyStyle}">${key}</div> <div>${value}</div>`
                               })
       tooltip.style("left", `${window.event.pageX + 10}px`)
              .style("top", `${window.event.pageY + 10}px`)
              .style("visibility", "visible")
       innerTooltip.html(tooltipHtml.join(""))
     }
     const tooltipMouseleave = d => tooltip.style("visibility", "hidden")
  
     const batchGroup = quiltSvg.selectAll(`.${slug}_batch`)
                                 .data(data["batches"], d => d.name)
                                 .join(
                                   enter => {
                                     let root = enter.append("g")
                                     root.attr("transform", (d, i) => `translate(0,${(batchCellHeight * i) + batchPadding})`)
  
                                     root.append("text")
                                         .attr("x", (seqLength * tableCellWidth) + 2)
                                         .attr("dy", batchCellHeight / 2)
                                         .style("font-family", "Arial")
                                         .style("font-size", "7pt")
                                         .style("fill", "#262626")
                                         .text(d => d.name)
                                         .append("svg:title")
                                         .text(d => d.name);
  
                                     root.append("rect")
                                         .attr("width", tableCellWidth * seqLength)
                                         .attr("height", batchCellHeight - batchPadding)
                                         .attr("stroke", "#000000")
                                         .attr("stroke-width", "0.5")
                                         .attr("fill", "none")
  
                                    return root
                                   },
                                 )
                                .selectAll(".batch_cells")
                                .data(d => stackGen(Object.keys(d.nuc_pct).map(key => d.nuc_pct[key])))
                                .join(
                                  enter => {
                                    let root = enter.append("g")
                                                    .attr("fill", d => color[d["key"]])
                                    return root
                                  }
                                )
                                .selectAll("rect")
                                .data(d => d.map((e, i) => { e.push(i); return e }).filter(e => !(isNaN(e[0]) || isNaN(e[1]))))
                                .join(
                                  enter => {
                                    let root = enter.append("rect")
                                                    .attr("x", function(d) {
                                                      if(this.parentNode.__data__.key == "Insertions") {
                                                        return (d[2] * tableCellWidth) + (0.75 * tableCellWidth)
                                                      } else {
                                                        return d[2] * tableCellWidth
                                                      }
                                                    })
                                                    .attr("y", function(d) {
                                                      if(this.parentNode.__data__.key == "Insertions") {
                                                        return batchCellHeight + (y(d[1]) - y(d[0])) - 2
                                                      } else {
                                                        return y(d[1])
                                                      }
                                                    })
                                                    .attr("height", d => y(d[0]) - y(d[1]))
                                                    .attr("width", function(d) {
                                                      if(this.parentNode.__data__.key == "Insertions") {
                                                        return tableCellWidth / 2
                                                      } else {
                                                        return tableCellWidth
                                                      }
                                                    })
                                    if(shadeReference) {
                                      root.style("opacity", function(d, i) {
                                        return this.parentNode.__data__.key == data["reference"][d[2]] ? 0.25 : 1
                                      })
                                    }
                                    return root
                                  }
                                )
                                .on("mouseover", tooltipMouseover)
                                .on("mouseleave", tooltipMouseleave)
  
     const guides = quiltSvg.selectAll(`.${slug}_guide`)
                            .data(data["sgRNAs"], d => d)
                            .join(
                              enter => {
                                let root = enter.append("g")
                                root.attr("transform", (d, i) => `translate(${(d["interval"][0] * tableCellWidth)},${(d["row"] * tableCellHeight) + batchHeight + guidePadding})`)
                                root.append("rect")
                                    .attr("width", d => (d["interval"][1] - d["interval"][0]) * tableCellWidth)
                                    .attr("height", tableCellHeight)
                                    .attr("stroke", "#FFFFFF")
                                    .style("fill", "#D9D9D9")
                                root.append("text")
                                    .attr("dx", "0.2em")
                                    .attr("dy", "1em")
                                    .attr("text-anchor", "start")
                                    .style("font-size", "6pt")
                                    .text(d => d.hasOwnProperty("name") ? d["name"] : "sgRNA")
                                return root
                              }
                            )
  
     const referenceGroup = quiltSvg.append("g")
                                    .attr("transform", `translate(0, ${batchHeight})`);
     referenceGroup.selectAll(".reference")
                   .data(d => data["reference"])
                   .join(enter => {
                     let root = enter.append("g")
                     root.append("rect")
                         .attr("fill", d => color[d])
                         .attr("width", tableCellWidth)
                         .attr("height", tableCellHeight)
                         .attr("x", (d, i) => i * tableCellWidth)
                         .attr("y", -10)
                         .style("opacity", "0.9")
                     root.append("text")
                         .attr("x", (d, i) => (i * tableCellWidth) + (tableCellWidth / 2))
                         .attr("text-anchor", "middle")
                         .attr("dy", "-0.2em")
                         .style("font-size", "6pt")
                         .style("font-family", "Arial")
                         .style("stroke-width", "0.3pt")
                         .style("fill", "#262626")
                         .text(d => d)
                     return root
                   })
     referenceGroup.append("text")
                   .attr("x", (seqLength * tableCellWidth) + 2)
                   .attr("dy", "-0.2em")
                   .style("font-family", "Arial")
                   .style("font-size", "7pt")
                   .style("fill", "#262626")
                   .text("Reference")
  
     const quantificationWindowGroup = quiltSvg.append("g");
  
     quantificationWindowGroup.selectAll(".quantificationWindow")
                              .data(d => data["quantification_windows"])
                              .join(enter => {
                                let root = enter.append("rect")
                                                .attr("transform", d => `translate(${d[0] * tableCellWidth}, 0)`)
                                                .attr("width", d => (d[1] - d[0] + 1) * tableCellWidth)
                                                .attr("height", quiltHeight - (guidePadding * 2) - 2)
                                                .style("stroke","#D9D9D9")
                                                .style("stroke-dasharray", "4,4")
                                                .style("stroke-width", "0.7pt")
                                                .style("fill", "none")
                                return root
                              })
  
     const legendGroup = d3.select(`#${slug}`).append("div"),
           legendData = Object.keys(color)
     legendData.push("Quantification Window")
  
     legendGroup.style("width", "12%").classed("d-flex", true).classed("align-items-center", true).classed("flex-column", true)
     legendGroup.append("h5")
                .text("Legend")
  
     legendGroup.selectAll(".legend")
                .attr("class", "text-center")
                .style("display", "grid")
                .style("grid-template-columns", "1fr 1fr")
                .style("column-gap", "10px")
                .data(d => legendData)
                .join(enter => enter.append("div")
                                  .style("background-color", d => color.hasOwnProperty(d) ? color[d] : "white")
                                  .style("color", d => d === '-' ? "white" : "black")
                                  .style("font-size", "0.7rem")
                                  .style("width", "75%")
                                  .classed("qw", d => d === "Quantification Window")
                                  .text(d => d)
                )
   }
  
   {% for slug in nucleotide_quilt_slugs %}
     buildNucleotideQuilt({{slug}}, "{{slug}}")
   {% endfor %}
  </script>